<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Éclairage public de Paris</title>
  <script src="https://js.arcgis.com/calcite-components/1.0.0-beta.77/calcite.esm.js" type="module"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/1.0.0-beta.77/calcite.css" />
  <script src="https://js.arcgis.com/4.22/"></script>
  <link id="jsapi-theme-dark" rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/dark/main.css" />
  <link disabled id="jsapi-theme-light" rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css" />
  <script>
    function hoverLink() {
      document.querySelector(".svg-icon").style.fill = "rgba(226, 119, 40, 0.93)";
      document.querySelector("#apiJS").style.color = "rgba(226, 119, 40, 0.93)";
    }

    function outLink() {
      document.querySelector(".svg-icon").style.fill = "#d1d1d1";
      document.querySelector("#apiJS").style.color = "#d1d1d1";
    }

    function hoverLink2() {
      document.querySelector("#openDataUrl").style.color = "rgba(226, 119, 40, 0.93)";
    }

    function outLink2() {
      document.querySelector("#openDataUrl").style.color = "#d1d1d1";
    }
  </script>

</head>
<style>
  html,
  body,
  #viewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }

  body {
    display: flex;
  }

  .esri-view .esri-view-surface--inset-outline:focus::after {
    outline: none !important;
  }

  .esri-popup__main-container.esri-widget.esri-popup--is-collapsible {
    width: auto !important;
  }

  calcite-loader {
    align-self: center;
    justify-self: center;
  }

  #header-title {
    margin-left: 1rem;
    margin-right: 1rem;
  }

  #info-content {
    padding: 0.75rem;
    font-size: 10px;
  }

  calcite-rating {
    margin-top: 0.25rem;
  }

  #theme-switcher {
    position: absolute;
    right: 0;
    margin: 0.75rem;
    z-index: 2;
    border: 1px solid;
    border-color: var(--calcite-ui-border-1);
    background-color: var(--calcite-ui-foreground-1);
  }

  .theme-icon {
    padding: 0.5rem;
    cursor: pointer;
  }

  a:link,
  a:visited,
  a:hover,
  a:active {
    text-decoration: none;
    color: #d1d1d1;
  }

  a:focus {
    outline: none !important;
  }

  .svg-icon {
    height: 22px;
    width: 22px;
    fill: #d1d1d1;
    font-weight: bold;
    position: relative;
    top: 8px;
    left: 8px;
  }

  div.text-container.text-container--visible {
    display: none !important;
  }
</style>

<body class="calcite-theme-dark">
  <calcite-loader active></calcite-loader>
  <calcite-shell content-behind hidden>

    <!--  theme switcher  -->
    <div slot="header" id="theme-switcher">
      <calcite-label disable-spacing layout="inline">
        <calcite-icon icon="moon" scale="s" class="theme-icon"></calcite-icon>
        <calcite-switch></calcite-switch>
        <calcite-icon icon="brightness" scale="s" class="theme-icon"></calcite-icon>
      </calcite-label>
    </div>

    <h2 id="header-title" slot="header">
      Éclairage public de Paris
    </h2>
    <calcite-shell-panel slot="primary-panel" detached>
      <calcite-action-bar slot="action-bar">
        <calcite-action data-action-id="layers" icon="layers" text="Couches"></calcite-action>
        <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
        <calcite-action data-action-id="legend" icon="legend" text="Légende"></calcite-action>
        <calcite-action data-action-id="print" icon="print" text="Impression"></calcite-action>
        <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
      </calcite-action-bar>
      <calcite-panel heading="Couches" height-scale="l" data-panel-id="layers" hidden>
        <div id="layers-container"></div>
      </calcite-panel>
      <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
        <div id="basemaps-container"></div>
      </calcite-panel>
      <calcite-panel heading="Légende" height-scale="l" data-panel-id="legend" hidden>
        <div id="legend-container"></div>
      </calcite-panel>
      <calcite-panel heading="Impression" height-scale="l" data-panel-id="print" hidden>
        <div id="print-container"></div>
      </calcite-panel>
      <calcite-panel heading="Détails" data-panel-id="information" hidden>
        <div id="info-content">
          <div>
            <u>Dev</u> : <a id="apiJS" href="https://developers.arcgis.com/javascript/" target="_blank" onmouseover="hoverLink()" onmouseout="outLink()">API ArcGIS for JavaScript</span><svg class="svg-icon" viewBox="0 0 48 53">
                <path d="M24.16 2.12L46 8v33.66l-22.14 9.23L2 45V11.9l22.16-9.78M24 0L0 10.6v35.92L24 53l24-10V6.48L24 0zM9 11v30h30V11zm16.33 23.4c0 2.92-1.72 4.25-4.21 4.25a4.37 4.37 0 0 1-4.23-2.58l2.29-1.39c.45.79.85 1.45 1.82 1.45s1.51-.36 1.51-1.77v-9.59h2.82zM32 38.65a5.4 5.4 0 0 1-5.13-2.88l2.29-1.33a3.07 3.07 0 0 0 2.78 1.71c1.17 0 1.91-.58 1.91-1.39 0-1-.76-1.31-2.05-1.87l-.7-.3c-2-.87-3.39-2-3.39-4.25 0-2.12 1.61-3.73 4.13-3.73a4.18 4.18 0 0 1 4 2.26l-2.2 1.41a1.91 1.91 0 0 0-1.81-1.21 1.23 1.23 0 0 0-1.35 1.21c0 .84.53 1.18 1.73 1.71l.71.3c2.39 1 3.74 2.07 3.74 4.43 0 2.54-1.99 3.93-4.66 3.93z">
                </path>
              </svg></a>
          </div>
          <p></p>
          <div>
            <div><u>Source</u> : <a id="openDataUrl" href="https://opendata.paris.fr/explore/dataset/eclairage-public/information" target="_blank" onmouseover="hoverLink2()" onmouseout="outLink2()">https://opendata.paris.fr/explore/dataset/eclairage-public/information</a></div>
            <p></p>
            <div><u>Symbologie</u> : "Bloom effect" + Opacité / Puissance nominale de la lampe</div>
          </div>
        </div>
      </calcite-panel>
    </calcite-shell-panel>
    <div id="viewDiv"></div>
  </calcite-shell>
</body>
<script>
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/widgets/Home",
    "esri/widgets/Bookmarks",
    "esri/widgets/BasemapGallery",
    "esri/widgets/LayerList",
    "esri/widgets/Legend",
    "esri/widgets/Print",
    "esri/core/watchUtils",
    "esri/config"
  ], function(Map, MapView, FeatureLayer, Home, Bookmarks, BasemapGallery, LayerList, Legend, Print, watchUtils, esriConfig) {
    esriConfig.apiKey = "AAPK551c88f8d25e4cb6a6fa84e30ea07c240tXPQnH9X28B5uBat8NrS16NXKresOv90auUds7afDCcdpnlA4rLVheETm_yQlL_";
    let scaleBloom;
    const markerSymbol = {
      type: "simple-marker",
      color: "rgba(226, 119, 40, 0.93)",
      size: "4px",
      outline: null
    }
    const opacityVisualVariable = {
      type: "opacity",
      field: "Puissance_nominale_de_la_lampe_",
      stops: [{
          value: 0,
          opacity: 0
        },
        {
          value: 50,
          opacity: 0.3
        },
        {
          value: 100,
          opacity: 0.6
        },
        {
          value: 1000,
          opacity: 1
        }
      ]
    };
    const layer = new FeatureLayer({
      url: "https://services.arcgis.com/OMbfIFNCWRclU5sp/arcgis/rest/services/eclairage_public/FeatureServer",
      outFields: ["*"],
      renderer: {
        type: "simple",
        symbol: markerSymbol,
        visualVariables: [opacityVisualVariable]
      },
      effect: "bloom(0.5, 0.5px, 0.1)"
    });
    const map = new Map({
      basemap: "dark-gray-vector",
      layers: [layer]
    });
    const view = new MapView({
      container: "viewDiv",
      map: map,
      center: [2.340640365234307, 48.858889699999175],
      zoom: 12,
      constraints: {
        minZoom: 11,
        maxZoom: 17,
        geometry: {
          type: "extent",
          xmin: 231207.0747265924,
          ymin: 6239562.641206136,
          xmax: 289910.7124495286,
          ymax: 6262340.8756350875,
          spatialReference: {
            wkid: 102100
          }
        }
      },
      popup: {
        defaultPopupTemplateEnabled: true,
        dockEnabled: true,
        dockOptions: {
          buttonEnabled: false,
          breakpoint: false,
          position: "bottom-right"
        }
      }
    });
    view.ui.add([{
      component: new Home({
        view: view
      }),
      position: "top-right"
    }]);
    view.ui.move("zoom", "top-right");
    view.ui.remove("attribution");
    const basemaps = new BasemapGallery({
      view,
      container: "basemaps-container"
    });
    const layerList = new LayerList({
      view,
      selectionEnabled: true,
      container: "layers-container"
    });
    const legend = new Legend({
      view,
      container: "legend-container"
    });
    const print = new Print({
      view,
      container: "print-container"
    });
    layer.when(() => {
      scaleBloom = watchUtils.pausable(view, "stationary", () => {
        if (view.scale) {
          // console.log("view", view);
          if (view.scale >= 72223.819286) {
            layer.effect = "bloom(0.5, 0.5px, 0.1)";
          }
          if (view.scale === 36111.909643) {
            layer.effect = "bloom(2, 0.5px, 0.3)";
          }
          if (view.scale === 18055.9548215) {
            layer.effect = "bloom(3, 0.5px, 0.2)";
          }
          if (view.scale === 9027.977411) {
            layer.effect = "bloom(5, 0.5px, 0.1)";
          }
          if (view.scale === 4513.9887055) {
            layer.effect = "bloom(10, 0.5px, 0.1)";
          }
          if (view.scale === 2256.9943525) {
            layer.effect = "bloom(10, 0.5px, 0)";
          }
        }
      })
      let activeWidget;
      const handleActionBarClick = ({
        target
      }) => {
        if (target.tagName !== "CALCITE-ACTION") {
          return;
        }
        if (activeWidget) {
          document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
          document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
        }
        const nextWidget = target.dataset.actionId;
        if (nextWidget !== activeWidget) {
          document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
          document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
          activeWidget = nextWidget;
        } else {
          activeWidget = null;
        }
      };
      document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);
      document.querySelector("calcite-shell").hidden = false;
      document.querySelector("calcite-loader").active = false;
      const toggleThemes = () => {
        // calcite theme
        document.body.classList.toggle("calcite-theme-light");
        // jsapi theme
        const dark = document.querySelector("#jsapi-theme-dark");
        const light = document.querySelector("#jsapi-theme-light");
        dark.disabled = !dark.disabled;
        light.disabled = !light.disabled;
        // jsapi basemap color
        // map.basemap = dark.disabled ? "arcgis-navigation" : "dark-gray-vector";
        if (dark.disabled) {
          scaleBloom.pause();
          map.basemap = "arcgis-navigation";
          layer.effect = "";
          layer.renderer = {
            type: "simple",
            symbol: markerSymbol
          }
        } else {
          scaleBloom.resume();
          map.basemap = "dark-gray-vector";
          layer.renderer = {
            type: "simple",
            symbol: markerSymbol,
            visualVariables: [opacityVisualVariable]
          }
        }
      };
      document.querySelector("calcite-switch").addEventListener("calciteSwitchChange", toggleThemes);
    });
  });
</script>

</html>